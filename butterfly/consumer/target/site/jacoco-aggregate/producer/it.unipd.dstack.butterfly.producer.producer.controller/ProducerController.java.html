<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ProducerController.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">JaCoCo</a> &gt; <a href="../index.html" class="el_bundle">producer</a> &gt; <a href="index.source.html" class="el_package">it.unipd.dstack.butterfly.producer.producer.controller</a> &gt; <span class="el_source">ProducerController.java</span></div><h1>ProducerController.java</h1><pre class="source lang-java linenums">package it.unipd.dstack.butterfly.producer.producer.controller;

import it.unipd.dstack.butterfly.config.AbstractConfigManager;
import it.unipd.dstack.butterfly.controller.Controller;
import it.unipd.dstack.butterfly.producer.producer.OnWebhookEvent;
import it.unipd.dstack.butterfly.producer.producer.OnWebhookEventFromTopic;
import it.unipd.dstack.butterfly.producer.producer.Producer;
import it.unipd.dstack.butterfly.producer.webhookhandler.WebhookHandler;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.servlet.http.HttpServletRequest;
import java.util.concurrent.CompletableFuture;

public abstract class ProducerController&lt;V&gt; implements Controller {
<span class="nc" id="L16">    private static final Logger logger = LoggerFactory.getLogger(ProducerController.class);</span>

    protected final AbstractConfigManager configManager;
    protected final String serviceName;
    private final String kafkaTopic;
    private final int serverPort;
    private final String webhookEndpoint;
    private final OnWebhookEventFromTopic&lt;V&gt; onWebhookEventFromTopic;
    protected final OnWebhookEvent&lt;V&gt; onWebhookEvent;
    private final WebhookHandler webhookHandler;

    private Producer&lt;V&gt; producer;

    public ProducerController(
            AbstractConfigManager configManager,
            Producer&lt;V&gt; producer,
            OnWebhookEventFromTopic&lt;V&gt; onWebhookEventFromTopic,
            WebhookHandler.HTTPMethod httpMethod
<span class="nc" id="L34">    ) {</span>
<span class="nc" id="L35">        this.configManager = configManager;</span>
<span class="nc" id="L36">        this.serviceName = configManager.getStringProperty(&quot;SERVICE_NAME&quot;);</span>
<span class="nc" id="L37">        this.kafkaTopic = configManager.getStringProperty(&quot;KAFKA_TOPIC&quot;);</span>
<span class="nc" id="L38">        this.serverPort = configManager.getIntProperty(&quot;SERVER_PORT&quot;);</span>
<span class="nc" id="L39">        this.webhookEndpoint = configManager.getStringProperty(&quot;WEBHOOK_ENDPOINT&quot;);</span>
<span class="nc" id="L40">        this.onWebhookEventFromTopic = onWebhookEventFromTopic;</span>

        /*
        this.onWebhookEvent = (V event) -&gt; {
            logger.info(serviceName + &quot; Received event: &quot; + event.toString());
            return onWebhookEventFromTopic.onEvent(producer, this.kafkaTopic)
                    .handleEvent(event);
        };
        */

        // this.onWebhookEvent = onWebhookEventFromTopic.onEvent(producer, this.kafkaTopic);
<span class="nc" id="L51">        this.onWebhookEvent = new ProducerOnWebhookEvent();</span>

<span class="nc" id="L53">        this.webhookHandler = new WebhookHandler.Builder()</span>
<span class="nc" id="L54">                .setRoute(this.webhookEndpoint)</span>
<span class="nc" id="L55">                .setMethod(httpMethod)</span>
<span class="nc" id="L56">                .setWebhookConsumer(this::onWebhookRequest)</span>
<span class="nc" id="L57">                .setExceptionConsumer(this::onWebhookException)</span>
<span class="nc" id="L58">                .create();</span>

<span class="nc" id="L60">        this.producer = producer;</span>

        /**
         * Graceful shutdown
         */
<span class="nc" id="L65">        this.gracefulShutdown();</span>
<span class="nc" id="L66">    }</span>

    /**
     * Spins up the controller.
     */
    final public void start() {
<span class="nc" id="L72">        logger.info(this.serviceName + &quot; started&quot;);</span>
<span class="nc" id="L73">        this.webhookHandler.listen(this.serverPort);</span>
<span class="nc" id="L74">        logger.info(this.serviceName + &quot; listening on port: &quot; + serverPort);</span>
<span class="nc" id="L75">        this.producer.awaitUntilError(this::onProduceException);</span>
<span class="nc" id="L76">    }</span>

    /**
     * Closes the controller and releases resources.
     */
    final public void close() {
<span class="nc" id="L82">        logger.info(&quot;Closing &quot; + this.serviceName);</span>
        // terminates the production process
<span class="nc" id="L84">        this.producer.close();</span>
<span class="nc" id="L85">        this.releaseResources();</span>
<span class="nc" id="L86">        logger.info(&quot;Released resources &quot; + this.serviceName);</span>
<span class="nc" id="L87">    }</span>

    /**
     * Invoked when an exception is thrown.
     * @param e
     */
    abstract public void onProduceException(Exception e);

    /**
     * Invoked when a webhook request isn't properly parseable.
     * @param e
     */
    abstract public void onWebhookException(Exception e);

    /**
     * Called when the third-party service sends an HTTP request to the producer app.
     * @param request
     */
    abstract public void onWebhookRequest(HttpServletRequest request);

    /**
     * Releases ProducerController's implementation's resources
     */
    protected void releaseResources() {
        // NO-OP if it isn't overridden
<span class="nc" id="L112">    }</span>

<span class="nc" id="L114">    private class ProducerOnWebhookEvent implements OnWebhookEvent&lt;V&gt; {</span>
<span class="nc" id="L115">        private OnWebhookEvent&lt;V&gt; onWebhookEvent =</span>
<span class="nc" id="L116">                onWebhookEventFromTopic.onEvent(producer, ProducerController.this.kafkaTopic);</span>

        /**
         * This method is called when a WebHook event has been received. The event object has info about the
         * specific event type and its data.
         *
         * @param event
         */
        @Override
        public CompletableFuture&lt;Void&gt; handleEvent(V event) {
<span class="nc" id="L126">            logger.info(serviceName + &quot; Received event: &quot; + event.toString());</span>
<span class="nc" id="L127">            return this.onWebhookEvent</span>
<span class="nc" id="L128">                    .handleEvent(event);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span>Code Coverage Report for JaCoCo 1.0-SNAPSHOT</div></body></html>